---
title: "Median DLNM Analysis"
author: "Jack A. Goldman"
date: "2025-12-26"
format: html
---

This use mgcv and dlnm packages to fit a distributed lag model for VPD and fire severity (RBR median)
We use a matrix of VPD values for each fire event (GID) with columns representing lags from 1 to 30 days before fire start date

# Objective
- Short-term increases in VPD (drying conditions) in the days leading up to fire ignition will lead to higher burn severity (RBR median)
- Long-term VPD trends (e.g., seasonal averages) may have less influence on burn severity compared to short-term fluctuations by decreasing fuel abundance

- lagged effects of VPD on burn severity will be non-linear, with immediate effects being stronger than delayed effects
- lagged effects of  CMI on burn severity will be non-linear, with immediate effects being stronger than delayed effects


The goal is to model the effects of short-term and long-term moisture conditions on median and extreme burn severity as having a non-linear, lagged effect and compare whether short-term or long-term moisture conditions better explain burn severity patterns.

# Hypotheses

To achieve this goal, I'll test 4 hypotheses for short and long-term moisture conditions (VPD and CMI (maybe RH and FWI?)) on both median and extreme (90th percentile) burn severity using a series of GAMs with distributed lag non-linear models implemented using the `mgcv`

1.  Is there an effect of moisture condition?

    -   H~A~: Same as H~A~ from \#1 above
    -   H~0~: Remove the moisture condition term entirely

2.  Is there a lagged effect?

    -   H~A~: Use the moisture condition at a lag with maximum effect suggested by the DLNM (e.g. VPD day before fire) as a parameteric (not smoothed) term.
    -   H~0~: Same as H~0~ from \#2 above

4. Is short-term or long-term moisture conditions more important? (anova between best models from short-term and long-term moisture conditions)

    -   H~A~: Full model including crossbasis smooth for short-term (30-day) moisture conditions.
    -   H~0~: Full model including crossbasis smooth for long-term (5 year lag) moisture conditions.


```{r}
library(ggplot2)
library(tidyr)
library(ggplot2)
library(viridis)
library(cowplot)
library(patchwork)
library(readr)
library(mgcv)
library(dlnm)
library(here)
library(gratia)
```


# Read in data

```{r}
moisture_data <- readRDS(here ("data", "analysis_ready","moisture_lagged_data.rds")) 
```

```{r}
#are there nas in the data
sum(is.na(moisture_data))
moisture_data <- moisture_data |>  
  filter(fire_size_ha > 200) |> 
  filter(ecoregion_lvl %in%c("LN", "BTL", "LSJ"))
```

# Build Full Models

## vpd


### vpd with distributed lag
```{r}

m_vpd_median <- bam(median ~ 
       te(vpd, L,  by = weights_btl, k = c(3,4), bs = c('tp', 'cr')) + # vpd with lag
       te(vpd, L,  by = weights_ln, k = c(3,4), bs = c('tp', 'cr')) + # vpd with lag
       te(vpd, L,  by = weights_lsj, k = c(3,4), bs = c('tp', 'cr')) + # vpd with lag
         pct_conf + fwi_90th  +
         mean_evi +  
        s(fyear,bs = "re") +
        s(ecoregion_lvl, bs = "re") ,
      data = moisture_data,
      family = scat(link = "identity"),
      select = TRUE,
      method = "fREML")

```

```{r}
m_vpd_ext <- bam(pct_90 ~ 
       te(vpd, L,  by = weights_btl, k = c(3,4), bs = c('tp', 'cr')) + # vpd with lag
       te(vpd, L,  by = weights_ln, k = c(3,4), bs = c('tp', 'cr')) + # vpd with lag
       te(vpd, L,  by = weights_lsj, k = c(3,4), bs = c('tp', 'cr')) + # vpd with lag
         pct_conf+ fwi_90th  +
         mean_evi +  
        s(fyear,bs = "re") +
        s(ecoregion_lvl, bs = "re") ,
      data = moisture_data,
      family = scat(link = "identity"),
      select = TRUE,
      method = "fREML")
```

## cmi

### cmi with distributed lag
```{r}

m_cmi_median <- bam(median ~ 
       te(cmi_wy, LL,  by = weights_btl2, k = c(3,4), bs = c('tp', 'cr')) + # vpd with lag
       te(cmi_wy, LL,   by = weights_ln2, k = c(3,4), bs = c('tp', 'cr')) + # vpd with lag
       te(cmi_wy, LL,   by = weights_lsj2, k = c(3,4), bs = c('tp', 'cr')) + # vpd with lag # cmi with 5 year lag
        pct_conf + 
        fwi_90th + 
        mean_evi + 
        s(fyear,bs = "re") +
        s(ecoregion_lvl, bs = "re") ,
      data = moisture_data,
      family = scat(link = "identity"),
      select = TRUE,
      method = "fREML")

```

```{r}
m_cmi_ext <- bam(pct_90 ~ 
       te(cmi_wy, LL,  by = weights_btl2, k = c(3,4), bs = c('tp', 'cr')) + # vpd with lag
       te(cmi_wy, LL,   by = weights_ln2, k = c(3,4), bs = c('tp', 'cr')) + # vpd with lag
       te(cmi_wy, LL,   by = weights_lsj2, k = c(3,4), bs = c('tp', 'cr')) + # vpd with lag # cmi with 5 year lag
        pct_conf + 
        fwi_90th + 
        mean_evi + 
        s(fyear,bs = "re") +
        s(ecoregion_lvl, bs = "re") ,
      data = moisture_data,
      family = scat(link = "identity"),
      select = TRUE,
      method = "fREML")
```

## save models

```{r}

saveRDS(m_vpd_median, here("analysis", "models","m_vpd_median.rds"))
saveRDS(m_cmi_median, here("analysis", "models","m_cmi_median.rds"))
saveRDS(m_vpd_ext, here("analysis", "models","m_vpd_ext.rds"))
saveRDS(m_cmi_ext, here("analysis", "models","m_cmi_ext.rds"))
```

## assess model fits

vpd
```{r}
gam.check(m_vpd_median)
```

cmi
```{r}
gam.check(m_cmi_median)

```

# H2: are short-term or long-term moisture conditions more important?

Compare aic between vpd and cmi full

```{r}
AIC(m_vpd_median, m_cmi_median) |> 
  rownames_to_column(var = "Model") |> 
  mutate(deltaAIC = AIC -min(AIC)) |> 
  arrange(deltaAIC) |>
  mutate_at(.vars = vars(df, AIC, deltaAIC), 
  .funs = funs(round, .args = list(digits=0)))
```

Long-term is marginally better a better model, better model than short-term moisture conditions

```{r}
summary(m_cmi_median)
summary(m_vpd_median)

```


# H3: Are relationships consistent between median and extreme?



# H4: are there lagged effects?

```{r}
estimates_btl <- get_lag_estimates(m_vpd_median, lag_var = "L", smooth_var = "vpd", weights = "weights_btl")
plot_vpd_btl <- plot_lag_smooth(m_vpd_median, estimates, "vpd", "L", "weights_btl")
plot_vpd_btl

estimates_lsj <- get_lag_estimates(m_vpd_median, lag_var = "L", smooth_var = "vpd", weights = "weights_lsj")
plot_vpd_lsj <- plot_lag_smooth(m_vpd_median, estimates_lsj, "vpd", "L", "weights_lsj")
plot_vpd_lsj

estimates_ln <- get_lag_estimates(m_vpd_median, lag_var = "L", smooth_var = "vpd", weights = "weights_ln")
plot_vpd_ln <- plot_lag_smooth(m_vpd_median, estimates_ln, "vpd", "L", "weights_ln")
plot_vpd_ln


```


```{r}
estimates_cmi <- get_lag_estimates(m_cmi_median,  "LL",  "cmi_wy", "weights_btl2")
plot_cmi <- plot_lag_smooth(m_cmi_median, estimates_cmi, "cmi_wy", "LL", "weights_btl2")

plot_cmi

estimates_cmi_lsj <- get_lag_estimates(m_cmi_median, lag_var = "LL", smooth_var = "cmi_wy", weights = "weights_lsj2")
plot_cmi_lsj <- plot_lag_smooth(m_cmi_median, estimates_cmi_lsj, "cmi_wy", "LL", "weights_lsj2")

plot_cmi_lsj

estimates_cmi_ln <- get_lag_estimates(m_cmi_median, lag_var = "LL", smooth_var = "cmi_wy", weights = "weights_ln2")
plot_cmi_ln <- plot_lag_smooth(m_cmi_median, estimates_cmi_ln, "cmi_wy", "LL", "weights_ln2")

plot_cmi_ln

```